!function(){"use strict";class t{constructor(t=1,e=0,i=0,s=1,r=0,o=0){this.set(t,e,i,s,r,o)}set(t=1,e=0,i=0,s=1,r=0,o=0){return this.a=t,this.b=e,this.c=i,this.d=s,this.tx=r,this.ty=o,this}identity(){return this.set()}toArray(){return[this.a,this.b,this.c,this.d,this.tx,this.ty]}fromArray(t){return this.set(t[0],t[1],t[2],t[3],t[4],t[5])}[Symbol.iterator](){return this.toArray()[Symbol.iterator]()}}class e{constructor(t=0,e=0){this.set(t,e)}set(t=0,e=0){return this.x=t,this.y=e,this}zero(){return this.set()}getArray(){return[this.x,this.y]}fromArray(t){return this.set(t[0],t[1])}[Symbol.iterator](){return this.getArray()[Symbol.iterator]()}}class i extends class{constructor(i=0,s=0,r=0,o=1,h=1){this.local=new t,this.world=new t,this._position=new e(i,s),this._scale=new e(o,h),this._skew=new e(0,0),this._origin=new e(0,0),this._rotation=r,this.dirty=!0}update(){if(!this.dirty)return!1;const{_a:t,_b:e,_c:i,_d:s,_position:r}=this;return this.local.set(t,e,i,s,r.x,r.y),this.dirty=!1,!0}setPosition(t,e){return this._position.set(t,e),this.dirty=!0,this}setScale(t,e=t){return this._scale.set(t,e),this.dirty=!0,this.updateCache(),this}setSkew(t,e){return this._skew.set(t,e),this.dirty=!0,this.updateCache(),this}setOrigin(t,e=t){return this._origin.set(t,e),this.dirty=!0,this}setRotation(t){return this.rotation=t,this}updateCache(){const{_rotation:t,_skew:e,_scale:i}=this;this._a=Math.cos(t+e.y)*i.x,this._b=Math.sin(t+e.y)*i.x,this._c=-Math.sin(t-e.x)*i.y,this._d=Math.cos(t-e.x)*i.y}set x(t){this._position.x=t,this.dirty=!0}get x(){return this._position.x}set y(t){this._position.y=t,this.dirty=!0}get y(){return this._position.y}set rotation(t){this._rotation=t,this.dirty=!0,this.updateCache()}get rotation(){return this._rotation}set scaleX(t){this._scale.x=t,this.dirty=!0,this.updateCache()}get scaleX(){return this._scale.x}set scaleY(t){this._scale.y=t,this.dirty=!0,this.updateCache()}get scaleY(){return this._scale.y}set originX(t){this._origin.x=t,this.dirty=!0}get originX(){return this._origin.x}set originY(t){this._origin.y=t,this.dirty=!0}get originY(){return this._origin.y}set skewX(t){this._skew.x=t,this.dirty=!0,this.updateCache()}get skewX(){return this._skew.x}set skewY(t){this._skew.y=t,this.dirty=!0,this.updateCache()}get skewY(){return this._skew.y}}{constructor(t,i,s,r,o=1,h=1,n=1,a=1){super(t,i),this.visible=!0,this.texture=null,this.uv={topLeft:{x:0,y:0},topRight:{x:1,y:0},bottomLeft:{x:0,y:1},bottomRight:{x:1,y:1}},this.bounds=null,this.gravity=.75,this.speedX=10*Math.random(),this.speedY=10*Math.random()-5,this._size=new e(s,r),this.topLeft=new e,this.topRight=new e,this.bottomLeft=new e,this.bottomRight=new e,this.rgba={r:o,g:h,b:n,a:a},this.setOrigin(.5,1),this.updateVertices()}setTexture(t){return this.texture=t,this._size.set(t.width,t.height),this.dirty=!0,this.updateVertices(),this}step(){this.x+=this.speedX,this.y+=this.speedY,this.speedY+=this.gravity,this.x>this.bounds.right?(this.speedX*=-1,this.x=this.bounds.right):this.x<this.bounds.left&&(this.speedX*=-1,this.x=this.bounds.left),this.y>this.bounds.bottom?(this.speedY*=-.85,this.y=this.bounds.bottom,Math.random()>.5&&(this.speedY-=6*Math.random())):this.y<this.bounds.top&&(this.speedY=0,this.y=this.bounds.top),this.updateVertices()}updateVertices(){if(!this.dirty)return!1;this.update();const t=this._size.x,e=this._size.y,i=-this._origin.x*t,s=i+t,r=-this._origin.y*e,o=r+e,{a:h,b:n,c:a,d:u,tx:g,ty:c}=this.local,b=i*h,l=i*n,d=r*a,m=r*u,x=s*h,_=s*n,f=o*a,p=o*u;return this.topLeft.set(b+d+g,l+m+c),this.topRight.set(x+d+g,_+m+c),this.bottomLeft.set(b+f+g,l+p+c),this.bottomRight.set(x+f+g,_+p+c),!0}batch(t,e){t[e+0]=this.topLeft.x,t[e+1]=this.topLeft.y,t[e+2]=this.rgba.r,t[e+3]=this.rgba.g,t[e+4]=this.rgba.b,t[e+5]=this.rgba.a,t[e+6]=this.uv.topLeft.x,t[e+7]=this.uv.topLeft.y,t[e+8]=this.bottomLeft.x,t[e+9]=this.bottomLeft.y,t[e+10]=this.rgba.r,t[e+11]=this.rgba.g,t[e+12]=this.rgba.b,t[e+13]=this.rgba.a,t[e+14]=this.uv.bottomLeft.x,t[e+15]=this.uv.bottomLeft.y,t[e+16]=this.bottomRight.x,t[e+17]=this.bottomRight.y,t[e+18]=this.rgba.r,t[e+19]=this.rgba.g,t[e+20]=this.rgba.b,t[e+21]=this.rgba.a,t[e+22]=this.uv.bottomRight.x,t[e+23]=this.uv.bottomRight.y,t[e+24]=this.topRight.x,t[e+25]=this.topRight.y,t[e+26]=this.rgba.r,t[e+27]=this.rgba.g,t[e+28]=this.rgba.b,t[e+29]=this.rgba.a,t[e+30]=this.uv.topRight.x,t[e+31]=this.uv.topRight.y}batchMultiTexture(t,e){const i=this.texture.glIndex,{r:s,g:r,b:o,a:h}=this.rgba;t[e+0]=this.topLeft.x,t[e+1]=this.topLeft.y,t[e+2]=s,t[e+3]=r,t[e+4]=o,t[e+5]=h,t[e+6]=this.uv.topLeft.x,t[e+7]=this.uv.topLeft.y,t[e+8]=i,t[e+9]=this.bottomLeft.x,t[e+10]=this.bottomLeft.y,t[e+11]=s,t[e+12]=r,t[e+13]=o,t[e+14]=h,t[e+15]=this.uv.bottomLeft.x,t[e+16]=this.uv.bottomLeft.y,t[e+17]=i,t[e+18]=this.bottomRight.x,t[e+19]=this.bottomRight.y,t[e+20]=s,t[e+21]=r,t[e+22]=o,t[e+23]=h,t[e+24]=this.uv.bottomRight.x,t[e+25]=this.uv.bottomRight.y,t[e+26]=i,t[e+27]=this.topRight.x,t[e+28]=this.topRight.y,t[e+29]=s,t[e+30]=r,t[e+31]=o,t[e+32]=h,t[e+33]=this.uv.topRight.x,t[e+34]=this.uv.topRight.y,t[e+35]=i}batchMultiTextureNoColor(t,e){const i=this.texture.glIndex;t[e+0]=this.topLeft.x,t[e+1]=this.topLeft.y,t[e+2]=this.uv.topLeft.x,t[e+3]=this.uv.topLeft.y,t[e+4]=i,t[e+5]=this.bottomLeft.x,t[e+6]=this.bottomLeft.y,t[e+7]=this.uv.bottomLeft.x,t[e+8]=this.uv.bottomLeft.y,t[e+9]=i,t[e+10]=this.bottomRight.x,t[e+11]=this.bottomRight.y,t[e+12]=this.uv.bottomRight.x,t[e+13]=this.uv.bottomRight.y,t[e+14]=i,t[e+15]=this.topRight.x,t[e+16]=this.topRight.y,t[e+17]=this.uv.topRight.x,t[e+18]=this.uv.topRight.y,t[e+19]=i}}class s{constructor(t,e,i=0){this.glIndex=0,this.key=t,this.gl=e,this.glIndex=i}onLoad(){const t=this.gl;this.glTexture=this.gl.createTexture(),t.activeTexture(t.TEXTURE0+this.glIndex),t.bindTexture(t.TEXTURE_2D,this.glTexture),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this.image),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),this.width=this.image.width,this.height=this.image.height,this.image.onload=null,this._onLoadCallback&&this._onLoadCallback(this)}load(t,e){this.image=new Image,this.image.onload=()=>this.onLoad(),this.image.src=t,e&&(this._onLoadCallback=e),this.image.complete&&this.image.width&&this.image.height&&this.onLoad()}}var r={fragmentShader:"\nprecision mediump float;\n\nvarying vec2 vTextureCoord;\nvarying float vTextureId;\n\nuniform sampler2D uTexture[%count%];\n\nvoid main (void)\n{\n    vec4 color;\n\n    %forloop%\n\n    gl_FragColor = color;\n}",vertexShader:"\nattribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\nattribute float aTextureId;\n\nuniform mat4 uProjectionMatrix;\n\nvarying vec2 vTextureCoord;\nvarying float vTextureId;\n\nvoid main (void)\n{\n    vTextureCoord = aTextureCoord;\n    vTextureId = aTextureId;\n\n    gl_Position = uProjectionMatrix * vec4(aVertexPosition, 0.0, 1.0);\n}"};class o{constructor(t=1,e=0,i=0,s=0,r=0,o=1,h=0,n=0,a=0,u=0,g=1,c=0,b=0,l=0,d=0,m=1){this.set(t,e,i,s,r,o,h,n,a,u,g,c,b,l,d,m)}set(t=1,e=0,i=0,s=0,r=0,o=1,h=0,n=0,a=0,u=0,g=1,c=0,b=0,l=0,d=0,m=1){return this.m00=t,this.m01=e,this.m02=i,this.m03=s,this.m10=r,this.m11=o,this.m12=h,this.m13=n,this.m20=a,this.m21=u,this.m22=g,this.m23=c,this.m30=b,this.m31=l,this.m32=d,this.m33=m,this}zero(){return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}identity(){return this.set()}getArray(){return[this.m00,this.m01,this.m02,this.m03,this.m10,this.m11,this.m12,this.m13,this.m20,this.m21,this.m22,this.m23,this.m30,this.m31,this.m32,this.m33]}fromArray(t){return this.set(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])}[Symbol.iterator](){return this.getArray()[Symbol.iterator]()}}const h=["precision mediump float;","void main(void){","float test = 0.1;","%forloop%","gl_FragColor = vec4(0.0);","}"].join("\n");function n(t){let e="";for(let i=0;i<t;++i)i>0&&(e+="\nelse "),i<t-1&&(e+=`if(test == ${i}.0){}`);return e}!function(){const t=800,e=600,a={left:0,top:0,right:t,bottom:e},u=document.getElementById("game");u.width=t,u.height=e;const g=u.getContext("webgl",{alpha:!1,antialias:!0,premultipliedAlpha:!1,stencil:!1,preserveDrawingBuffer:!1});let c=function(t,e){const i=e.createShader(e.FRAGMENT_SHADER);for(;;){const s=h.replace(/%forloop%/gi,n(t));if(e.shaderSource(i,s),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS))break;t=t/2|0}return t}(g.getParameter(g.MAX_TEXTURE_IMAGE_UNITS),g);console.log("maxTextures",c,"out of",g.getParameter(g.MAX_TEXTURE_IMAGE_UNITS));for(let t=0;t<c;t++){let e=g.createTexture();g.activeTexture(g.TEXTURE0+t),g.bindTexture(g.TEXTURE_2D,e),g.texImage2D(g.TEXTURE_2D,0,g.RGBA,1,1,0,g.RGBA,g.UNSIGNED_BYTE,new Uint8Array([0,0,255,255]))}const b=Array.from(Array(c).keys());let l=r.fragmentShader;l=l.replace(/%count%/gi,`${c}`),l=l.replace(/%forloop%/gi,function(t){let e="";for(let i=0;i<t;i++)i>0&&(e+="\n    else "),i<t-1&&(e+=`if (vTextureId < ${i}.5)`),e+="\n    {",e+=`\n        color = texture2D(uTexture[${i}], vTextureCoord);`,e+="\n    }";return e}(c));const d=g.createShader(g.FRAGMENT_SHADER);g.shaderSource(d,l),g.compileShader(d);const m=g.createShader(g.VERTEX_SHADER);g.shaderSource(m,r.vertexShader),g.compileShader(m);const x=g.createProgram();g.attachShader(x,m),g.attachShader(x,d),g.linkProgram(x),g.useProgram(x);const _=g.getAttribLocation(x,"aVertexPosition"),f=g.getAttribLocation(x,"aTextureCoord"),p=g.getAttribLocation(x,"aTextureId"),y=g.getUniformLocation(x,"uProjectionMatrix"),R=g.getUniformLocation(x,"uTexture");g.enableVertexAttribArray(_),g.enableVertexAttribArray(f),g.enableVertexAttribArray(p);let T=0,E=!1;const A=new Float32Array(16e4);let v=[];for(let t=0;t<8e3;t+=4)v.push(t+0,t+1,t+2,t+2,t+3,t+0);const L=g.createBuffer();g.bindBuffer(g.ARRAY_BUFFER,L),g.bufferData(g.ARRAY_BUFFER,A,g.DYNAMIC_DRAW),g.bindBuffer(g.ARRAY_BUFFER,null);const w=g.createBuffer();g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,w),g.bufferData(g.ELEMENT_ARRAY_BUFFER,new Uint16Array(v),g.STATIC_DRAW),g.bindBuffer(g.ARRAY_BUFFER,null);const S=function(t,e,i,s,r,h){const n=1/(t-e),a=1/(i-s),u=1/(r-h);return new o(-2*n,0,0,0,0,-2*a,0,0,0,0,2*u,0,(t+e)*n,(s+i)*a,(h+r)*u,1)}(0,t,e,0,-1e3,1e3),U=[];!function(t){let e=t.length;const i=()=>{e--,0===e&&function(){F(2e3),window.addEventListener("mousedown",()=>{E=!0}),window.addEventListener("mouseup",()=>{E=!1});for(let t=0;t<U.length;t++)g.activeTexture(g.TEXTURE0+t),g.bindTexture(g.TEXTURE_2D,U[t].glTexture);M()}()};t.forEach((t,e)=>{let r=new s(t,g,U.length);r.load("../assets/bunnies/"+t,i),U.push(r)})}(["rabbitv3.png","rabbitv3_ash.png","rabbitv3_batman.png","rabbitv3_bb8.png","rabbitv3_frankenstein.png","rabbitv3_neo.png","rabbitv3_sonic.png","rabbitv3_spidey.png","rabbitv3_stormtrooper.png","rabbitv3_superman.png","rabbitv3_tron.png","rabbitv3_wolverine.png"]);const I=[];function F(t){for(let e=0;e<t;e++){let t=U[T%U.length],e=new i(T%2*800,0,25,32);e.bounds=a,e.setTexture(t),I.push(e),T++}}function C(t){const e=80*t;if(16e4===e)g.bufferData(g.ARRAY_BUFFER,A,g.DYNAMIC_DRAW);else{let t=A.subarray(0,e);g.bufferSubData(g.ARRAY_BUFFER,0,t)}g.drawElements(g.TRIANGLES,6*t,g.UNSIGNED_SHORT,0)}function M(){E&&T<2e5&&F(200),g.clearColor(0,0,0,1),g.clear(g.COLOR_BUFFER_BIT),g.enable(g.BLEND),g.blendFunc(g.ONE,g.ONE_MINUS_SRC_ALPHA),g.viewport(0,0,u.width,u.height),g.uniformMatrix4fv(y,!1,S),g.uniform1iv(R,b),g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,w),g.bindBuffer(g.ARRAY_BUFFER,L),g.vertexAttribPointer(_,2,g.FLOAT,!1,20,0),g.vertexAttribPointer(f,2,g.FLOAT,!1,20,8),g.vertexAttribPointer(p,1,g.FLOAT,!1,20,16);let t=0;for(let e=0;e<I.length;e++){let i=I[e];i.step(),i.batchMultiTextureNoColor(A,20*t),2e3===t?(C(t),t=0):t++}t>0&&C(t),requestAnimationFrame(M)}}()}();
