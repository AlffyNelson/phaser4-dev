class DrawCall{constructor(a,b,c){var d=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;this.gl=a,this.appState=b,this.currentProgram=c,this.drawPrimitive=a.TRIANGLES,this.currentVertexArray=d,this.appState=b,this.uniformIndices={},this.uniformNames=Array(b.maxUniforms),this.uniformValues=Array(b.maxUniforms),this.uniformCount=0,this.uniformBuffers=Array(b.maxUniformBuffers),this.uniformBlockNames=Array(b.maxUniformBuffers),this.uniformBlockCount=0,this.textures=Array(b.maxTextureUnits),this.textureCount=0,this.offsets=new Int32Array(1),this.numElements=new Int32Array(1),this.numInstances=new Int32Array(1),this.currentVertexArray&&(this.numElements[0]=this.currentVertexArray.numElements,this.numInstances[0]=this.currentVertexArray.numInstances),this.numDraws=1;}setPrimitive(a){return this.drawPrimitive=a,this}uniform(a,b){var c=this.uniformIndices[a];return void 0===c&&(c=this.uniformCount++,this.uniformIndices[a]=c,this.uniformNames[c]=a),this.uniformValues[c]=b,this}drawRanges(){this.numDraws=arguments.length,this.offsets.length<this.numDraws&&(this.offsets=new Int32Array(this.numDraws)),this.numElements.length<this.numDraws&&(this.numElements=new Int32Array(this.numDraws)),this.numInstances.length<this.numDraws&&(this.numInstances=new Int32Array(this.numDraws));for(var a,b=0;b<this.numDraws;++b)a=0>b||arguments.length<=b?void 0:arguments[b],this.offsets[b]=a[0],this.numElements[b]=a[1],this.numInstances[b]=a[2]||1;return this}draw(){var a=this.gl,b=this.appState,c=this.uniformNames,d=this.uniformValues,e=this.uniformBuffers,f=this.currentProgram.uniformBlockCount,g=this.textures,h=this.currentProgram.samplerCount,j=this.drawPrimitive,k=this.numElements,l=this.numInstances,m=this.currentVertexArray,n=this.offsets,o=this.numDraws,p=!1;this.currentProgram.bind(),m&&(m.bind(),p=m.indexed);for(var q=0;q<this.uniformCount;q++)this.currentProgram.uniform(c[q],d[q]);for(var r=0;r<f;r++)e[r].bind(r);for(var s=0;s<h;s++)g[s].bind(s);if(b.multiDrawInstanced){var t=b.extensions.multiDrawInstanced;p?t.multiDrawElementsInstancedWEBGL(j,k,0,m.indexType,n,0,l,0,o):t.multiDrawArraysInstancedWEBGL(j,n,0,k,0,l,0,o);}else if(p)for(var u=0;u<o;u++)a.drawElementsInstanced(j,k[u],m.indexType,n[u],l[u]);else for(var i=0;i<o;i++)a.drawArraysInstanced(j,n[i],k[i],l[i]);return this}}

var TYPE_SIZE={5120:1,5121:1,5122:2,5123:2,5124:4,5125:4,5126:4};function GetTypeSize(a){return TYPE_SIZE[a]}

var SAMPLER_TYPE=["1i",1,Int32Array,!1],glConstMap={35678:SAMPLER_TYPE,36289:SAMPLER_TYPE,35682:SAMPLER_TYPE,36292:SAMPLER_TYPE,36298:SAMPLER_TYPE,36303:SAMPLER_TYPE,36306:SAMPLER_TYPE,36311:SAMPLER_TYPE,35680:SAMPLER_TYPE,36300:SAMPLER_TYPE,36308:SAMPLER_TYPE,36293:SAMPLER_TYPE,35679:SAMPLER_TYPE,36299:SAMPLER_TYPE,36307:SAMPLER_TYPE,5126:["1f",1,Float32Array,!1],35664:["2f",2,Float32Array,!1],35665:["3f",3,Float32Array,!1],35666:["4f",4,Float32Array,!1],5124:["1i",1,Int32Array,!1],35667:["2i",2,Int32Array,!1],35668:["3i",3,Int32Array,!1],35669:["4i",4,Int32Array,!1],5125:["1ui",1,Uint32Array,!1],36294:["2ui",2,Uint32Array,!1],36295:["3ui",3,Uint32Array,!1],36296:["4ui",4,Uint32Array,!1],35674:["2fv",4,Float32Array,!0],35675:["3fv",9,Float32Array,!0],35676:["4fv",16,Float32Array,!0],35685:["2x3fv",6,Float32Array,!0],35686:["2x4fv",8,Float32Array,!0],35687:["3x2fv",6,Float32Array,!0],35688:["3x4fv",12,Float32Array,!0],35689:["4x2fv",8,Float32Array,!0],35690:["4x3fv",12,Float32Array,!0],35670:["1iv",1,Array,!1],35671:["2iv",2,Array,!1],35672:["3iv",3,Array,!1],35673:["4iv",4,Array,!1]};function GetUniform(a,b){var c=glConstMap[b];if(c){var d="uniform";return c[3]&&(d=d.concat("Matrix")),{glFunc:a[d+c[0]],size:c[1],cacheClass:a=>new c[2](a)}}return null}

class MatrixUniform{constructor(a,b,c,d){this.gl=a,this.handle=b,this.count=d;var e=GetUniform(a,c.type);this.glFunc=e.glFunc,this.cache=e.cacheClass(e.size*d);}set(a){for(var b=0;b<a.length;b++)if(this.cache[b]!==a[b])return this.glFunc(this.handle,!1,a),void this.cache.set(a)}}

class MultiBoolUniform{constructor(a,b,c,d){this.gl=a,this.handle=b,this.count=d;var e=GetUniform(a,c.type);this.glFunc=e.glFunc,this.cache=Array(e.size*d).fill(!1);}set(a){for(var b=0;b<a.length;b++)if(this.cache[b]!==a[b]){this.glFunc(this.handle,a);for(var c=b;c<a.length;c++)this.cache[c]=a[c];return}}}

class MultiNumericUniform{constructor(a,b,c,d){this.gl=a,this.handle=b,this.count=d;var e=GetUniform(a,c.type);this.glFunc=e.glFunc,this.cache=e.cacheClass(e.size*d);}set(a){for(var b=0;b<a.length;b++)if(this.cache[b]!==a[b])return this.glFunc(this.handle,a),void this.cache.set(a)}}

var UNIFORMS={SAMPLER:[35678,36298,36306,35682,36289,36303,36311,36292,35680,36300,36308,36293,35679,36299,36307],VEC:[35664,35667,36294,35665,35668,36295,35666,35669,36296],BOOL:[35670,35671,35672,35673],MAT:[35674,35675,35676,35685,35686,35687,35688,35689,35690]};

class Shader{constructor(a,b,c,d){this.gl=a,this.appState=b,this.type=c,this.source=d,this.restore();}restore(){var a=this.gl,b=a.createShader(this.type);return a.shaderSource(b,this.source),a.compileShader(b),this.shader=b,this}delete(){return this.shader&&(this.gl.deleteShader(this.shader),this.shader=null),this}checkCompilation(){var a=this.gl,b=this.shader;if(!a.getShaderParameter(b,a.COMPILE_STATUS)){console.error(a.getShaderInfoLog(b));for(var c=this.source.split("\n"),d=0;d<c.length;++d)console.error("".concat(d+1,": ").concat(c[d]));}return this}}

class SingleComponentUniform{constructor(a,b,c){this.gl=a,this.handle=b;var d=GetUniform(a,c.type);this.glFunc=d.glFunc,this.cache=c.type!==a.BOOL&&0;}set(a){this.cache!==a&&(this.glFunc(this.handle,a),this.cache=a);}}

class Program{constructor(a,b,c,d){this.uniforms={},this.uniformBlocks={},this.uniformBlockCount=0,this.samplers={},this.samplerCount=0,this.linked=!1,this.gl=a,this.appState=b,"string"==typeof c?this.vertexSource=c:this.vertexShader=c,"string"==typeof d?this.fragmentSource=d:this.fragmentShader=d,this.initialize();}initialize(){var a=this.gl,b=this.appState;return b.program===this&&(a.useProgram(null),b.program=null),this.linked=!1,this.uniformBlockCount=0,this.samplerCount=0,this.vertexSource&&(this.vertexShader=new Shader(a,b,a.VERTEX_SHADER,this.vertexSource)),this.fragmentSource&&(this.fragmentShader=new Shader(a,b,a.FRAGMENT_SHADER,this.fragmentSource)),this.program=this.gl.createProgram(),this}link(){var a=this.gl,b=this.program;return a.attachShader(b,this.vertexShader.shader),a.attachShader(b,this.fragmentShader.shader),a.linkProgram(b),this}checkCompletion(){return !this.gl.getExtension("KHR_parallel_shader_compile")||this.gl.getProgramParameter(this.program,37297)}checkLinkage(){if(this.linked)return this;var a=this.gl,b=this.program;return a.getProgramParameter(b,a.LINK_STATUS)?(this.linked=!0,this.initVariables()):(console.error(a.getProgramInfoLog(b)),this.vertexShader.checkCompilation(),this.fragmentShader.checkCompilation()),this.vertexSource&&(this.vertexShader.delete(),this.vertexShader=null),this.fragmentSource&&(this.fragmentShader.delete(),this.fragmentShader=null),this}initVariables(){this.bind();for(var a,b=this.gl,c=this.program,d=b.getProgramParameter(c,b.ACTIVE_UNIFORMS),e=0;e<d;e++){var f=b.getActiveUniform(c,e),g=b.getUniformLocation(c,f.name),h=f.type,j=f.size;-1===UNIFORMS.SAMPLER.indexOf(h)?-1===UNIFORMS.VEC.indexOf(h)?-1===UNIFORMS.MAT.indexOf(h)?-1===UNIFORMS.BOOL.indexOf(h)?h===b.INT||h===b.UNSIGNED_INT||h===b.FLOAT?1<j?this.uniforms[f.name]=new MultiNumericUniform(b,g,f,j):this.uniforms[f.name]=new SingleComponentUniform(b,g,f):console.error("Unknown uniform type"):1<j?this.uniforms[f.name]=new MultiBoolUniform(b,g,f,j):this.uniforms[f.name]=new SingleComponentUniform(b,g,f):this.uniforms[f.name]=new MatrixUniform(b,g,f,j):this.uniforms[f.name]=new MultiNumericUniform(b,g,f,j):(a=this.samplerCount++,this.samplers[f.name]=a,b.uniform1i(g,a));}for(var k=b.getProgramParameter(c,b.ACTIVE_UNIFORM_BLOCKS),l=0;l<k;l++){var m=b.getActiveUniformBlockName(c,l),n=b.getUniformBlockIndex(c,m),o=this.uniformBlockCount++;b.uniformBlockBinding(c,n,o),this.uniformBlocks[m]=o;}}uniform(a,b){return this.uniforms[a]&&this.uniforms[a].set(b),this}bind(){var a=this.appState;return a.program!==this&&(this.gl.useProgram(this.program),a.program=this),this}delete(){return this.program&&(this.gl.deleteProgram(this.program),this.program=null,this.appState.program===this&&(this.gl.useProgram(null),this.appState.program=null)),this}}

class VertexArray{constructor(a,b){this.gl=a,this.appState=b,this.vertexArray=null,this.indexType=null,this.indexed=!1,this.numElements=0,this.numInstances=1,this.offsets=0,this.numDraws=1;}restore(){var a=this.appState;return a.vertexArray===this&&(a.vertexArray=null),null!==this.vertexArray&&(this.vertexArray=this.gl.createVertexArray()),this}vertexAttributeBuffer(a,b,c){return this.attributeBuffer(a,b,c,!1),this}instanceAttributeBuffer(a,b,c){return this.attributeBuffer(a,b,c,!0),this}indexBuffer(a){var b=this.gl;return null===this.vertexArray&&(this.vertexArray=b.createVertexArray()),this.bind(),b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,a.buffer),this.numElements=3*a.numItems,this.indexType=a.type,this.indexed=!0,this}delete(){return this.vertexArray&&(this.gl.deleteVertexArray(this.vertexArray),this.vertexArray=null,this.appState.vertexArray===this&&(this.gl.bindVertexArray(null),this.appState.vertexArray=null)),this}bind(){return this.appState.vertexArray!==this&&(this.gl.bindVertexArray(this.vertexArray),this.appState.vertexArray=this),this}attributeBuffer(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},d=3<arguments.length?arguments[3]:void 0,e=this.gl;null===this.vertexArray&&(this.vertexArray=e.createVertexArray()),this.bind(),e.bindBuffer(e.ARRAY_BUFFER,b.buffer);var{type:f=b.type,size:g=b.itemSize,offset:h=0,normalized:j=!1,integer:k=b.integer&&!j}=c,{stride:l=0}=c,m=b.numColumns;0===l&&(l=m*g*GetTypeSize(f));for(var n=0;n<m;n++)k?e.vertexAttribIPointer(a+n,g,f,l,h+n*g*GetTypeSize(f)):e.vertexAttribPointer(a+n,g,f,j,l,h+n*g*GetTypeSize(f)),d&&e.vertexAttribDivisor(a+n,1),e.enableVertexAttribArray(a+n);return 1===this.numDraws&&(d?this.numInstances=b.numItems:this.numElements=this.numElements||b.numItems),e.bindBuffer(e.ARRAY_BUFFER,null),this}}

class VertexBuffer{constructor(a,b,c,d,e){var f=5<arguments.length&&arguments[5]!==void 0?arguments[5]:a.STATIC_DRAW,g=!!(6<arguments.length&&arguments[6]!==void 0)&&arguments[6];this.gl=a,this.appState=b,this.buffer=null;var h=1;c===a.FLOAT_MAT4||c===a.FLOAT_MAT4x2||c===a.FLOAT_MAT4x3?h=4:c===a.FLOAT_MAT3||c===a.FLOAT_MAT3x2||c===a.FLOAT_MAT3x4?h=3:(c===a.FLOAT_MAT2||c===a.FLOAT_MAT2x3||c===a.FLOAT_MAT2x4)&&(h=2),c===a.FLOAT_MAT4||c===a.FLOAT_MAT3x4||c===a.FLOAT_MAT2x4?(d=4,c=a.FLOAT):c===a.FLOAT_MAT3||c===a.FLOAT_MAT4x3||c===a.FLOAT_MAT2x3?(d=3,c=a.FLOAT):(c===a.FLOAT_MAT2||c===a.FLOAT_MAT3x2||c===a.FLOAT_MAT4x2)&&(d=2,c=a.FLOAT);var i,j;"number"==typeof e?(i=e,c&&(e*=GetTypeSize(c)),j=e):(j=e.byteLength,i=e.length),this.type=c,this.itemSize=d,this.numItems=c?i/(d*h):j/d,this.numColumns=h,this.byteLength=j,this.usage=f,this.indexArray=!!g,this.integer=c===a.BYTE||c===a.UNSIGNED_BYTE||c===a.SHORT||c===a.UNSIGNED_SHORT||c===a.INT||c===a.UNSIGNED_INT,this.binding=this.indexArray?a.ELEMENT_ARRAY_BUFFER:a.ARRAY_BUFFER,this.restore(e);}restore(a){var b=this.gl,c=this.appState,d=this.binding;return c.vertexArray&&(b.bindVertexArray(null),c.vertexArray=null),this.buffer=b.createBuffer(),b.bindBuffer(d,this.buffer),void 0===a?b.bufferData(d,this.byteLength,this.usage):b.bufferData(d,a,this.usage),b.bindBuffer(d,null),this}data(a){var b=this.gl,c=this.appState,d=this.binding;return c.vertexArray&&(b.bindVertexArray(null),c.vertexArray=null),b.bindBuffer(d,this.buffer),b.bufferSubData(d,0,a),b.bindBuffer(d,null),this}delete(){return this.buffer&&(this.gl.deleteBuffer(this.buffer),this.buffer=null),this}}

class WebGL2Renderer{constructor(a,b){this.width=0,this.height=0,this.viewport={x:0,y:0,width:0,height:0},this.currentDrawCalls=0,this.contextLostExt=null,this.contextRestoredHandler=null;var c=a.getContext("webgl2",b);this.gl=c,this.canvas=a,this.setState(),this.initExtensions(),this.width=c.drawingBufferWidth,this.height=c.drawingBufferHeight,this.setViewport(0,0,this.width,this.height),this.clearBits=c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT|c.STENCIL_BUFFER_BIT,this.contextLostExt=null,this.contextRestoredHandler=null,this.canvas.addEventListener("webglcontextlost",a=>{a.preventDefault();}),this.canvas.addEventListener("webglcontextrestored",()=>{this.initExtensions(),this.contextRestoredHandler&&this.contextRestoredHandler();});}setState(){var a=Math.min,b=this.gl,c=b.getParameter(b.MAX_COMBINED_TEXTURE_IMAGE_UNITS),d=b.getParameter(b.MAX_UNIFORM_BUFFER_BINDINGS);return this.state={program:null,vertexArray:null,transformFeedback:null,activeTexture:-1,textures:Array(c),uniformBuffers:Array(d),freeUniformBufferBases:[],drawFramebuffer:null,readFramebuffer:null,extensions:{debugShaders:b.getExtension("WEBGL_debug_shaders"),multiDrawInstanced:b.getExtension("WEBGL_multi_draw_instanced")},maxTextureUnits:c,maxUniformBuffers:d,maxUniforms:a(b.getParameter(b.MAX_VERTEX_UNIFORM_VECTORS),b.getParameter(b.MAX_FRAGMENT_UNIFORM_VECTORS)),samples:b.getParameter(b.SAMPLES),parallelShaderCompile:!!b.getExtension("KHR_parallel_shader_compile"),multiDrawInstanced:!!b.getExtension("WEBGL_multi_draw_instanced")},this}loseContext(){return this.contextLostExt&&this.contextLostExt.loseContext(),this}restoreContext(){return this.contextLostExt&&this.contextLostExt.restoreContext(),this}onContextRestored(a){return this.contextRestoredHandler=a,this}initExtensions(){var a=this.gl;a.getExtension("EXT_color_buffer_float"),a.getExtension("OES_texture_float_linear"),a.getExtension("WEBGL_compressed_texture_s3tc"),a.getExtension("WEBGL_compressed_texture_s3tc_srgb"),a.getExtension("WEBGL_compressed_texture_etc"),a.getExtension("WEBGL_compressed_texture_astc"),a.getExtension("WEBGL_compressed_texture_pvrtc"),a.getExtension("EXT_disjoint_timer_query_webgl2"),a.getExtension("EXT_disjoint_timer_query"),a.getExtension("EXT_texture_filter_anisotropic"),this.contextLostExt=a.getExtension("WEBGL_lose_context"),a.getExtension("KHR_parallel_shader_compile");}setViewport(a,b,c,d){var e=this.viewport;return (e.width!==c||e.height!==d||e.x!==a||e.y!==b)&&(e.x=a,e.y=b,e.width=c,e.height=d,this.gl.viewport(a,b,c,d)),this}defaultViewport(){return this.setViewport(0,0,this.width,this.height),this}resize(a,b){return this.canvas.width=a,this.canvas.height=b,this.width=this.gl.drawingBufferWidth,this.height=this.gl.drawingBufferHeight,this.setViewport(0,0,this.width,this.height),this}colorMask(c,d,e,b){return this.gl.colorMask(c,d,e,b),this}clearColor(c,d,e,b){return this.gl.clearColor(c,d,e,b),this}clearMask(a){return this.clearBits=a,this}clear(){return this.gl.clear(this.clearBits),this}createProgram(a,b){var c=new Program(this.gl,this.state,a,b);return c.link().checkLinkage(),c}createVertexArray(){return new VertexArray(this.gl,this.state)}createVertexBuffer(a,b,c,d){return new VertexBuffer(this.gl,this.state,a,b,c,d)}createDrawCall(a,b){return new DrawCall(this.gl,this.state,a,b)}}

var fs="#version 300 es\nprecision highp float;\n\nin vec3 vColor;\n\nout vec4 fragColor;\nvoid main() {\n    fragColor = vec4(vColor, 1.0);\n}\n",app=new WebGL2Renderer(document.getElementById("game"),{});app.clearColor(0,0,0,1);var positions=app.createVertexBuffer(app.gl.FLOAT,2,new Float32Array([-.5,-.5,.5,-.5,0,.5])),colors=app.createVertexBuffer(app.gl.UNSIGNED_BYTE,3,new Uint8Array([255,0,0,0,255,0,0,0,255])),triangleArray=app.createVertexArray().vertexAttributeBuffer(0,positions,{}).vertexAttributeBuffer(1,colors,{normalized:!0}),program=app.createProgram("#version 300 es\n\nlayout(location=0) in vec4 position;\nlayout(location=1) in vec3 color;\n\nout vec3 vColor; \nvoid main() {\n    vColor = color;\n    gl_Position = position;\n}\n",fs),drawCall=app.createDrawCall(program,triangleArray);app.clear(),drawCall.draw();
